---
title: "Cena paliwa w Polsce"
author: "Szymon Lisowski"
date: "6/28/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
# library(bbplot)
# library(devtools)
library(ggannotate)
library(tidyverse)
library(ggtext)
library(lubridate)
```

```{r}
# Reading mean Pb 95 prices on gas stations in Poland
page <- readLines("https://www.bankier.pl/gospodarka/wskazniki-makroekonomiczne/eu-95-pol")

# Make points where the page contains important information
from <- which(page == page[str_detect(page, "// Create the chart")]) 
to  <- which(page == page[str_detect(page, "var intraday_dane")])[2] 

# Subset page
prices_url <-page[from:to][2]

# Split string on ',' and unlist
prices_url <- unlist(str_split(prices_url, pattern = ","))

# Make a sequence to further subset removing unnecesary data in this case between column which will be added later.
seq <- seq(1, length(prices_url), by = 2)

# Subset the data by sequence
prices_url <- prices_url[c(seq)]

# Subset the prices
prices_url_price <- prices_url[seq(1, length(prices_url),by = 2)]
prices_url_price <- gsub(".*:", "", prices_url_price)

# Subset the date
prices_url_date <- prices_url[seq(2, length(prices_url),by = 2)]
prices_url_date <- str_sub(prices_url_date, start = 9, end = 18)

# Combine in one table and add start and end column as well as year and week
prices_PB_95 <- data.frame(price =  prices_url_price, start = as.Date(prices_url_date) - lubridate::days(7), end = prices_url_date) %>% arrange(desc(start)) %>% mutate(year = year(end), week = week(end), price = as.numeric(price))

# Read USD/PLN and add year and week columns. Make weekly data
usdpln <- read.csv("https://stooq.com/q/d/l/?s=usdpln&i=d") %>% select(Date, Close) %>% mutate(year = year(Date), week = week(Date)) %>% group_by(year, week) %>% summarise(usdpln = mean(Close))

# Read Brent Oil prices and add year and week data columns. Make weekly data
brent <- gdata::read.xls("http://www.eia.gov/dnav/pet/hist_xls/RBRTEd.xls", sheet = 2, skip = 2) %>% 
         mutate(Date = mdy(Date)) %>% 
         rename(brent = last_col()) %>% 
         filter(Date > as.Date("2004-01-01")) %>% 
         mutate(week = week(Date), year = year(Date)) %>% 
         group_by(year, week) %>% 
         summarise(brent = mean(brent), Date) %>% 
         filter(row_number() == 1) %>% 
         arrange(desc(Date)) 

# Join Pb 95 prices with Brent Oil and USD/PLN
data <- prices_PB_95 %>% inner_join(brent,  by = c("year", "week")) %>% inner_join(usdpln, by = c("year", "week")) %>% mutate(brentPLN = brent * usdpln) %>% select(-c(brent, usdpln, start, end))

# Read wholesale prices for Pb 95
ceny_hurtowe <- readLines("https://www.lotos.pl/145/type,oil_95/dla_biznesu/hurtowe_ceny_paliw/archiwum_cen_paliw")

# Make points where the page contains important information
from <- which(ceny_hurtowe == ceny_hurtowe[str_detect(ceny_hurtowe, "Opłata paliwowa")]) + 6
to  <- which(ceny_hurtowe == ceny_hurtowe[str_detect(ceny_hurtowe, "mainContent__footer")]) - 6

# Subset page
ceny_hurtowe <- ceny_hurtowe[from:to]

# Detect and remove 'td'
ceny_hurtowe <- ceny_hurtowe[str_detect(ceny_hurtowe, "td")] 

# Leave only numeric values
ceny_hurtowe <- gsub("[^0-9,-]", "", ceny_hurtowe)

# Change ',' to '.'
ceny_hurtowe <- gsub(",", ".", ceny_hurtowe)

# Make a function to assign data to correct column
function_seq <- function(data, i) {
  table <- data[seq(i, length(data), by = 4)]
}

# Run function
ceny_hurtowe <- data.frame(sapply(1:4, function_seq, data = ceny_hurtowe))

# Apply column names
colnames(ceny_hurtowe) <- c("Date", "price_hurt", "excise", "fuel_surcharge")

# Mutate Date column
ceny_hurtowe <- ceny_hurtowe %>% mutate(Date = as.Date(Date), across(2:4, as.numeric))

# Transform data
ceny_hurtowe <- ceny_hurtowe %>% mutate(across(2:4, ~ .x / 1000)) %>% mutate(year =  year(Date), week = week(Date)) %>% group_by(year, week) %>% mutate(across(2:4, mean), price_hurt = price_hurt - excise - fuel_surcharge) %>% filter(row_number() == 1)

# Information on how much observations there is from 2022-02-01 when VAT rate for Pb 95 gasoline was decreased from 23% to 8%
times <- nrow(data %>% filter(Date > as.Date("2022-02-01")))

# Information on how much observations there is from 2019-01-01 when emission tax was implemented
times_emission_tax <- nrow(data %>% filter(Date > as.Date("2019-01-01")))

# Create a share data
VAT_share <- c(rep(0.074, times), rep(0.187, nrow(data) - times))
store_margin_share <- c(rep(0.04, nrow(data)))
emission_tax <- c(rep(0.1, times_emission_tax), rep(0, nrow(data) - times_emission_tax))

# Bind share data
shares <- bind_cols(VAT_share, store_margin_share, emission_tax)

# Apply column names
colnames(shares) <- c("VAT_share", "store_margin_share", "emission_tax")

# Join data with wholesale prices
data <- data %>% inner_join(ceny_hurtowe, by = c("year", "week")) 

# Transform data
data <- data %>% bind_cols(shares) %>% mutate(emission_tax_share = emission_tax / price, price_model = (price_hurt + excise + fuel_surcharge) / (1 - (VAT_share + store_margin_share + emission_tax_share)), VAT = price * VAT_share, store_margin = store_margin_share * price) %>% select(-Date.y) %>% rename(Date = Date.x)

# Order column names
data <- data %>% select(order(colnames(data)))

# Write csv
write_csv(data, "Oil/Processed_data/full_data.csv")
```


``` {r}
# Modelowa cena w stosunku do ceny realnej. Różnice wynikają z założeń modelu w postaci stałej wielkości marży stacji i zmienności rynku.
palette <- wesanderson::wes_palette("Zissou1", 6, type = "continuous")

data %>% filter(Date > as.Date("2020-01-01")) %>%
  ggplot() +
  geom_line(aes(x = Date, y = price, color = "Cena detaliczna"), color = "black") +
  geom_line(aes(x = Date, y = price_model, color = "Cena modelowa"), color = "darkgreen") +
  geom_line(aes(x = Date, y = price_hurt, color = "Cena hurtowa")) +
  geom_line(aes(x = Date, y = VAT, color = "VAT")) +
  geom_line(aes(x = Date, y = emission_tax, color = "Podatek emisyjny")) +
  geom_line(aes(x = Date, y = fuel_surcharge, color = "Opłata paliwowa")) +
  geom_line(aes(x = Date, y = excise, color = "Akcyza")) +
  geom_line(aes(x = Date, y = store_margin, color = "Marża stacji")) +
  geom_hline(yintercept = 0) +
  scale_color_manual(name = NULL, values = c(palette)) +
  theme_minimal() +
  labs(x = NULL, y = NULL, title = "Wartość poszczególnych czynników cenotwórczych dla paliwa Pb95") +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank())

ggsave("Model_vs_actual_price.png", dpi = 900, width = 20, height = 10, unit = "cm")

```

``` {r}
palette <- wesanderson::wes_palette("Zissou1", 2, type = "continuous")

# Making a plot for how hurt price and brent prices are connected
data %>% filter(Date > as.Date("2022-01-01")) %>%
  ggplot() +
  geom_line(aes(x = Date, y = 100 * price_hurt / last(price_hurt), color = "Cena hurtowa"), size = 0.75) +
  geom_line(aes(x = Date, y = 100 * brentPLN / last(brentPLN), color = "Brent Oil"), size = 0.75) +
  # geom_hline(yintercept = 0) +
  # geom_hline(yintercept = 1, linetype = 2) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %Y") +
  scale_color_manual(name = NULL, values = c("Cena hurtowa" = palette[1], "Brent Oil" = palette[2])) +
  # labs(x = NULL, y = NULL, title = "<span style='color:#3B9AB2;'>Cena w hurcie</span> oderwała się od notowań <span style='color:#F21A00;'>Brent Oil</span>") +
  labs(x = NULL, y = NULL, title = 'Cena w hurcie "oderwała" się od notowań Brent Oil', subtitle = "100 = poziom cen w dniu 01.01.2022") +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        plot.title = element_markdown(),
        plot.subtitle = element_text(size = 8),
        legend.position = "bottom",
        axis.text.x = element_text(angle = 90))

ggsave("Wholesale_vs_brent_price.png", dpi = 900, width = 20, height = 10, unit = "cm")

# https://www.orlen.pl/content/dam/internet/orlen/pl/pl/relacje-inwestorskie/raporty-i-publikacje/sprawozdania/2022/1q2022/Dane%20finansowo-operacyjne%20według%20segmentów%20działalności_1Q2022_PL.pdf.coredownload.pdf
```
  Powyższy wykres pozwala zauważyć pewne zależności między ceną hurtową a notowaniami BRENT. Wraz z upływem czasu ceny hurtowe zaczęły coraz bardziej odstawać od cen BRENT co w mediach szybko zostało mianowane efektem nadmiernych zysków rafinerii i chciwości prezesów korporacji. W istocie odchylenie zaczęło rosnąć co jednak można  wytłumaczyć szeregiem innych czynników. Są nimi wojna i wszelkie konsekwencje z tego tytułu: ograniczenie kupna rosyjskiej ropy, nagły wzrost popytu, rosnąca inflacja wpływająca na wzrost kosztów działalności, wzrost stóp procentowych, wzrost pozostałych czynników produkcyjnych w tym gazu ziemnego i energii elektrycznej oraz wzrost konsumpcji paliw z uwagi na znoszenie ograniczeń pandemicznych i powrót do trendu popytu sprzed pandemii. Ostatni czynnik może stanowić część odpowiedzi dla wzrostów z okresu kwiecień-czerwiec. Wówczas następował znaczny wzrost popytu na paliwo na polskim rynku co w obecnym otoczeniu makroekonomicznym łatwo prowadzi do osiągnięcia  stanu nierównowagi rynkowej i co za tym stoi nadmiernego wzrostu cen produktu. Z jednej strony można zauważyć, że moce przerobowe rafinerii dla samej Grupy Orlen wynoszą 35,2 mln ton, a dla Lotos 5 mln ton co pokrywa dotychczasowy poziom konsumpcji w Polsce. Z drugiej strony wartości te są maksymalnymi możliwościami i ich osiągnięcie wymaga czasu i obniżenia efektywności rafinerii co przekłada się na cenę. Z tego też względu w 2020 r. produkcja krajowa wynosiła "tylko" 26,3 i 27,2 mln ton dla 2021 r. Na marginesie należy zaznaczyć, że produkcja krajowa częściowo jest eksportowana (kilka %) co sprawia, że ostatecznie na rynku w  Polsce do dyspozycji zostaje mniej paliwa. Konsumpcja wynosiła dla tych lat odpowiednio  32,7 i 35 mln ton. Nadmierny popyt był dotychczas uzupełniany importem z zagranicy, często ze wschodu. Rosja od wielu lat stanowiła główne źródło importu ropy naftowej. W 2021 r. było to 60,9%. Taki udział świadczy o znacznym uzależnieniu się od dostaw pochodzących z Rosji co wraz z rozwojem wojny w Ukrainie ostatecznie, z uwagi na ograniczone zdolności przetwórcze, doprowadziło do nadmiernego wzrostu cen. 

Spośród wymienionych zmiennych bynajmniej są to wszystkie zmienne wpływające na poziom cen na stacjach. Są one jednak jednymi z ważniejszych zmiennych.

```{r fig.width=6, fig.height=2.8}
share_data <- data %>% select(Date, price_hurt, excise, VAT, store_margin, emission_tax, fuel_surcharge)

share_data  <- share_data %>% pivot_longer(cols = -Date, values_to = "price") %>% mutate(name = (factor(name, levels = c("price_hurt", "excise", "VAT", "store_margin", "fuel_surcharge", "emission_tax"))))

palette <- wesanderson::wes_palette("Zissou1", 6, type = "continuous")

share_data <- share_data %>% filter(Date > as.Date("2020-01-01"))

share_data %>%
ggplot(aes(fill=name, x=Date, y=price)) + 
    geom_bar(position="fill", stat="identity", width = 15) +
    geom_vline(xintercept = as.Date("2022-02-03"), color = "#333333") +
    geom_curve(data = data.frame(x = as.Date("2021-10-01"),
        y = 0.747391474149104, xend = as.Date("2022-01-09"),
        yend = 0.583470506718382),
        mapping = aes(x = x, y = y, xend = xend, yend = yend),
        curvature = 0.49, arrow = arrow(20L, unit(0.1, "inches"),
        "last", "closed"),
        inherit.aes = FALSE, color = "#333333") +
    geom_text(data = data.frame(x = as.Date("2021-09-28"),
      y = 0.818102479707454, label = "Obniżka VAT na paliwo \n z 23% do 8%"),
      mapping = aes(x = x, y = y, label = label),
      inherit.aes = FALSE, color = "#333333") +
    # annotate("text", x = as.Date("2021-06-01"), y = 0.85, label = "Obniżka VAT na paliwo\nz 23% do 8%")
    scale_fill_manual(values = palette, labels = c("cena hurtowa", "akcyza", "VAT", "marża stacji", "opłata paliwowa", "podatek emisyjny"), name = NULL) +
    scale_x_date(date_breaks = "6 months", date_labels = "%b %Y", limits = c(floor_date(min(share_data$Date), "month"), max(share_data$Date))) + 
    coord_cartesian(expand = c(0,0)) +
    labs(y = NULL, x = NULL, title = "Procentowy udział poszczególnych czynników cenotwórczych paliwa Pb95 w Polsce od 2020 r.") +
    theme_minimal() +
    theme(panel.grid = element_blank(),
          axis.text.x = element_text(angle = 90),
          axis.text.y = element_blank(),
          plot.title = element_text(hjust = 0))

ggsave("Czynniki_cenotwórcze_Pb95.png", dpi  = 900, width = 20, height = 10, unit = "cm")
```

## OLD DATA 

```{r}
cena_paliwa <- read.csv("/Users/mr.fox/Desktop/Cena 95 w Polsce.csv", sep = ";", dec = ",") 
USD_PLN <- read_csv("/Users/mr.fox/Desktop/USD_PLN Historical.csv")
BRENT <- read_csv("/Users/mr.fox/Desktop/Brent Oil Futures Historical.csv")
colnames(USD_PLN)
USD_PLN <- USD_PLN %>% select(Date, Price, "Change %") %>% mutate(Date = mdy(Date), USD_PLN = Price) %>% select(-Price)
BRENT <- BRENT %>% select(Date, Price) %>% mutate(Date = mdy(Date), BRENT = Price) %>% select(-Price) #mutate(BRENT_PLN = BRENT * USD_PLN, perc_change_BRENT_PLN = 100 * (BRENT_PLN[] / BRENT_PLN[-1] - 1))

cena_paliwa_1 <- cena_paliwa %>% mutate(Date = dmy(Date)) %>% rename(Gasoil = Price) %>%
  mutate(other = 0.05 * Gasoil, VAT = 0.08 * Gasoil, Raf = Gasoil - Akcyza - Opłata.paliwowa - other - VAT, Raf_perc = 100*(Raf[] / Raf[-1] - 1)) #0.08 od 2022-02-01. Przed 0.23
ceny <- cena_paliwa_1 %>%
  inner_join(USD_PLN, by = "Date") %>%
  inner_join(BRENT, by = "Date") %>%
  mutate(BRENT_PLN = BRENT * USD_PLN,
         perc_change_BRENT_PLN = 100 * (BRENT_PLN[] / BRENT_PLN[-1] - 1),
         ideal_raf_margin = (1 + perc_change_BRENT_PLN/100) * Raf / Gasoil,
         real_raf_margin = Raf / Gasoil,
         model_gasoil = ideal_raf_margin * Gasoil + Akcyza + Opłata.paliwowa + other + VAT)
         # stand_gasoil = (Gasoil - mean(Gasoil)) / sd(Gasoil),
         # stand_BRENT_PLN = (BRENT_PLN - mean(BRENT_PLN)) / sd(BRENT_PLN),
         # stand_BRENT = (BRENT - mean(BRENT)) / sd(BRENT))

cenyooo <- ceny %>%
  filter(Date > "2022-02-02")
ggplot(cenyooo, aes(x = Date)) +
  geom_line(aes(y = ideal_raf_margin), color = "blue") +
  geom_line(aes(y = real_raf_margin), color = "red") 

ggplotly(
  ggplot(cenyooo, aes(x = Date)) +
    geom_line(aes(y = Gasoil)) +
    geom_line(aes(y = model_gasoil), color = "red")
)

cor(cenyooo$ideal_raf_margin, cenyooo$real_raf_margin)
lmHeight = lm(real_raf_margin~ideal_raf_margin, data = cenyooo)
summary(lmHeight)

  ceny_ppp <- ceny %>%
    filter(Date > "2022-02-02") 
ggplotly(
  ggplot(ceny_ppp, aes(x = Date)) +
    geom_line(aes(y = perc_change_BRENT_PLN)) +
    geom_line(aes(y = Raf_perc), color = "red")
)

# Mogę dodać zmienne będące pomnożoną wartością Gasoil i np. opłatą akcyzową (chociaż ona jest stała i ją znam- tutaj to nie  ma  sensu). W ten sposób obliczę jakie zyski czerpie rafineria i czy nie występuje w niej nadmierny zysk polegający na 1 - wszystkie inne czynniki cenotwórcze. Powinno to działać na tej zasadzie, że koszt zakupu determinowany będzie ceną ropy z dnia bieżącego po odjęciu innych czynników. Wzrost ceny ropy w stosunku do dnia poprzedniego powinien sprawiać, że następuje taki sam wzrost (lub mniejszy jeśli wzrost cen jest wchłaniany przez spadek marży rafinerii). Jeśli będzie większy to oznacza, że rafinerie czerpały nadmierne zyski.

# Koszt zakupu w rafinerii – 64%;
# Opłata akcyzowa – 22%;
# Podatek VAT – 10%;
# Opłata paliwowa – 2%
# Opłata emisyjna – 1%
# Marża detaliczna stacji – 1%.


ggplotly(
  ggplot(ceny, aes(x = Date)) +
    geom_line(aes(y = stand_BRENT_PLN)) +
    geom_line(aes(y = stand_gasoil), color = "#AC2B2D") +
    geom_line(aes(y = stand_BRENT), color = "blue") +
    theme_classic() 
)

ggplotly(
  ggplot(ceny, aes(x = Date)) +
    #geom_line(aes(y = stand_BRENT_PLN)) +
    geom_line(aes(y = Gasoil), color = "#AC2B2D") +
   # geom_line(aes(y = stand_BRENT), color = "blue") +
    theme_classic() 
)

ggplotly(
  ggplot(ceny, aes(x = Date)) +
    #geom_line(aes(y = stand_BRENT_PLN)) +
    #geom_line(aes(y = Gasoil), color = "#AC2B2D") +
    geom_line(aes(y = BRENT_PLN), color = "blue") +
    theme_classic() 
)

ggplotly(
  ggplot(ceny, aes(x = Date)) +
    geom_line(aes(y = Gasoil)) +
    geom_line(aes(y = Akcyza), color = "red") +
    geom_line(aes(y = Opłata.paliwowa), color = "blue") +
    bbc_style()
)

```

```{r}
tail(ceny, n = 10)

ceny_st <- ceny %>%
  mutate(BRENT_PLN = BRENT_PLN / last(ceny$BRENT_PLN),
         Gasoil = Gasoil / last(ceny$Gasoil))

ceny %>% filter(Date > "2020-01-22", Date < "2020-06-25") %>% select(1:6) %>% mutate(baryłka = BRENT / 159)

ggplotly(
  ggplot(ceny_st, aes(x = Date)) +
    geom_line(aes(y = BRENT_PLN), color = "blue") +
    geom_line(aes(y = Gasoil), color = "#AC2B2D") +
    theme_classic()
)
```

```{r}
new_BRENT <- read.csv("/Users/mr.fox/Desktop/Brent Oil Futures Weekly.csv") %>% 
  mutate(Date = mdy(Date)) %>% 
  filter(Date <= "2022-06-15") %>%
  select(1,2,7)

cena_paliwa <- read.csv("/Users/mr.fox/Desktop/Cena 95 w Polsce.csv", sep = ";", dec = ",") 

new_ceny_paliwa <- read.csv("/Users/mr.fox/Desktop/Cena 95 w Polsce tygodniowo.csv", sep = ";", dec = ",") %>% 
  mutate(DDate = dmy(Ddate)) %>% 
  filter(DDate <= "2022-06-15", DDate >= "2010-07-02") %>%
  select(-Ddate, - DDate)

new_USD_PLN <- read.csv("/Users/mr.fox/Desktop/USD_PLN Historical Weekly.csv") %>% 
  mutate(Date = mdy(Date)) %>% 
  filter(Date <= "2022-06-15") %>%
  select(1,2,6)



ceny_hurt <- cena_paliwa %>%
  mutate(date = dmy(Date), year = year(date), week = week(date), month = month(date)) %>%
  group_by(year, week) %>%
  summarise(mean_hurt = mean(Price)) %>%
  ungroup() %>%
  #mutate(year = as.numeric(year), week = as.numeric(week)) 
  arrange(desc(year), desc(week)) %>%
  mutate(year = as.numeric(year), week = as.numeric(week)) %>%
  mutate(Date = as.Date(paste(year, week, 7, sep="-"), "%Y-%U-%u")) %>%
  drop_na() %>%
  slice_head(n = 624) %>%
  slice_tail(n = 622) %>%
  select(-c(year, week))
  
new_df <- new_BRENT %>%
  left_join(new_USD_PLN, by = "Date") %>%
  cbind(new_ceny_paliwa) %>%
  left_join(ceny_hurt, by = "Date") %>%
  mutate(mean_hurt = ifelse(is.na(mean_hurt), mean_hurt[+1], mean_hurt))


new_df_1 <- new_df %>%
  #arrange(Date) %>%
  mutate(brent_pln = Price.x * Price.y,
         brent_change = (brent_pln[] / brent_pln[-1] - 1)*100,
         brent_change = ifelse(abs(brent_change) > 40, NA, brent_change),
         real_raf = mean_hurt / Gasoline,
         other_factors = Gasoline - mean_hurt,
         model_Gasoline = (1 + brent_change/100) * real_raf * Gasoline[-1] + other_factors
         )




##### Usuwanie / dodawanie komentarzy poprzez zaznaczenie linijki / linijek kodu i wykorzystanie skrótu CTRL + SHIFT + C

p <-  ggplot(new_df_1, aes(x = Date)) +
    geom_line(aes(y = model_Gasoline), size = 0.6, color = "#AC2B2D") +
    geom_line(aes(y = Gasoline), size = 0.9) +
    geom_hline(yintercept = 3, size = 1, colour="#333333") +
  # scale_x_date(breaks = as.Date(c("2011-01-01","2015-01-01", "2020-01-01", "2022-01-01")),
  #              labels = c("2011", "2015", "2020", "2022")) +
    scale_x_date(breaks = seq.Date(from = as.Date("2010-01-01"), to = as.Date("2022-01-01"), by = "2 years"),
                 date_labels = "%Y") +
  # xlim(c(as.Date("2009-06-01"), NA)) +
    coord_cartesian(xlim = c(as.Date("2010-01-01"), NA)) +
    bbc_style() +
    theme(
      plot.title = element_markdown(),
      plot.subtitle = element_markdown()) +
    labs(title = "Gasoline price in Poland goes up in line with the  brent oil price increase", 
         y = NULL, 
         subtitle = "What the gas price <span style='color:#AC2B2D;'>**should be**</span> based on brent oil price changes <span style='color:#111111;'>vs </span>**actual prices**") 
    

p

finalise_plot(plot_name = p,
              save_filepath = "Pb95_prices_in_Poland.png",
              width_pixels = 1000, #640 is default
              height_pixels = 550, #550 is default
              source = "Source: Own study")

```

## How have the mean retail price changed since mid 2010 regarding changes in brent oil prices.

```{r}

new_df_2 <- new_df_1 %>%
  mutate(brent_pln = brent_pln / last(new_df_1$brent_pln),
         Gasoline = Gasoline / last(new_df_1$Gasoline),
         variable_oil_price = real_raf * Gasoline,
         mean_hurt = mean_hurt / last(new_df_1$mean_hurt))

ggplotly(

new_df_2 %>% mutate(variable_oil_price = variable_oil_price / last(new_df_2$variable_oil_price)) %>%
  ggplot(aes(x = Date)) +
  geom_line(aes(y = brent_pln), color = "blue") +
  geom_line(aes(y = mean_hurt))

)
```

As we can see, the mean retail price was moving slower compared to brent prices due to a number of other factors cotributing to retail price. Brent oil index is a price for a barrel of raw, unrafined oil. It has to be processed in order to be used as regular fuel. These processing costs make up a significant portion of a retail price. We can observe it when we transofrm our brent oil data from price per barrel to price per liter. One barell contains about 159 liters. On below chart retail price was divided on two parts- one of processing costs and the other of brent oil costs. 

```{r}
new_df_3 <- new_df_1 %>%
  mutate(brent_pln_liter = brent_pln / 159,
         perc_brent_costs = brent_pln_liter / mean_hurt,
         perc_processing_costs  =  1  -  perc_brent_costs)

ggplotly(
  ggplot(new_df_3, aes(x = Date)) +
  # geom_line(aes(y = brent_pln_liter), color = "red") +
  # geom_line(aes(y = mean_hurt), color = "blue") +
  geom_line(aes(y = perc_processing_costs))
)


ggplotly(
  ggplot(new_df_3, aes(x = Date)) +
  geom_line(aes(y = brent_pln_liter), color = "red") +
  geom_line(aes(y = mean_hurt), color = "blue") +
  geom_line(aes(y = Gasoline))
)

```

There is, however, one thing concerning me. If it really is the case that refineries keep their margin fixed, why does the divergence between gasoline price and brent per liter rise? Is it due to higher cost of  processing? It  is definitely an important factor as it contributed on average `mround(ean(new_df_3$perc_processing_costs) * 100)` %. This suggests that 

``` {r}
ggplotly(
  ggplot(new_df_3, aes(x = Date)) +
    geom_line(aes(y = Gasoline - brent_pln_liter))
)

round(mean(new_df_3$perc_processing_costs) * 100)
```

